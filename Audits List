-- VIEW AUDIT OBJECTS PRESENT IN STARIPS

SELECT AUD.Audit_Object_Id AS AUD_OBJ_ID 
			, OBJ_CLS.ObjClass_Name AS VESSEL
			, OBJ_AUD.Obj_Code AS AUD_CODE
			, OBJ_AUD.Obj_Description AS AUD_DESCR
			, AUD.AUDITTYPE_ID AS INSP_TYPE_ID
			, AUDTYP.AUDITTYPE_DESCR AS INSP_TYPE_DESCR
			, CASE 
					WHEN CHARINDEX('CDI', AUD.AUDITTYPE_ID) > 0 THEN 'CDI'
					WHEN CHARINDEX('PSC', AUD.AUDITTYPE_ID) > 0 THEN 'PSC'
					WHEN CHARINDEX('SIRE', AUD.AUDITTYPE_ID) > 0 THEN 'SIRE'
					ELSE '-'			
			  END AS INSP_TYPE_GENERIC
--			, AUD.AUDIT_COMPADDROBJID AS INSP_BY_ID
			, OBJ_INSPBY.Obj_Description AS INSP_BY_DESCR
--			, AUD.AUDIT_PORTOFINSPECTION AS INSP_WHERE_ID
			, LOC.Loc_Descr AS INSP_WHERE
--			, AUD_OPRN.AUDIT_VO_DESCR AS OPERATION
			, CASE 
					WHEN CHARINDEX('Discharg', AUD_OPRN.AUDIT_VO_DESCR) > 0 THEN 'Discharge'
					WHEN CHARINDEX('Load', AUD_OPRN.AUDIT_VO_DESCR) > 0 THEN 'Load'
					ELSE  AUD_OPRN.AUDIT_VO_DESCR		
			  END AS OPERATION
			, AUD.AUdit_Date AS INSP_DATE
			, OBJ_PERSON.Obj_Code AS AUDIT_RESP_PERSON
			, (SELECT COUNT(NC_Object_Id) AS NCCOUNT FROM ST_NonConformity WHERE Audit_Object_Id = AUD.Audit_Object_Id AND Rec_Deleted = 0) AS FINDINGS_COUNT
FROM ST_Audit AS AUD 
	INNER JOIN ST_Object AS OBJ_AUD ON OBJ_AUD.Object_Id = AUD.Audit_Object_Id 
	INNER JOIN ST_ObjectClass AS OBJ_CLS ON OBJ_CLS.ObjClass_Id = OBJ_AUD.ObjClass_Id AND OBJ_CLS.Rec_Deleted = 0
	LEFT OUTER JOIN ST_Object AS OBJ_PERSON ON OBJ_PERSON.Object_Id = AUD.Audit_RespPersonObjID
	LEFT OUTER JOIN ST_Object AS OBJ_INSPBY ON OBJ_INSPBY.Object_Id = AUD.AUDIT_COMPADDROBJID AND OBJ_INSPBY.ObjType_Id = 120
	LEFT OUTER JOIN ST_AUDITTYPE AS AUDTYP ON AUDTYP.AUDITTYPE_ID = AUD.AUDITTYPE_ID
	LEFT OUTER JOIN ST_Location AS LOC ON LOC.Loc_Code = AUD.AUDIT_PORTOFINSPECTION
	LEFT OUTER JOIN ST_AUDIT_VO AS AUD_OPRN ON AUD_OPRN.AUDIT_VO_ID = AUD.AUDIT_VO_ID
WHERE YEAR(AUD.AUdit_Date) >= 2017
	AND OBJ_CLS.ObjClass_Name NOT IN ('Bow Asia', 'Bow Singapore', 'Bow Fuling', 'Bow Dalian', 'Bow Nangang', 'Bow Victor', 'Bow Aratu')
ORDER BY VESSEL ASC, INSP_DATE ASC
